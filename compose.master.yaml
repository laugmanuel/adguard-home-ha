services:
  adguard:
    container_name: adguard
    image: ghcr.io/laugmanuel/adguard-home-ha:main
    restart: unless-stopped

    ### For host networking mode ###
    # cap_add:
    #   - NET_ADMIN
    # network_mode: host

    ### for IPVlan networking mode ###
    networks:
      - adguard

    volumes:
      - ./data/config:/opt/adguardhome/conf
      - ./data/work:/opt/adguardhome/work
    environment:
      TZ: Europe/Berlin
      KEEPALIVED_ENABLED: true
      KEEPALIVED_STATE: MASTER
      KEEPALIVED_VIP: "192.168.0.2"
      ADGUARD_CONFIG_SYNC_ENABLED: true
      ADGUARD_CONFIG_SYNC_ROLE: PRIMARY
    healthcheck:
      test: nslookup k.root-servers.net 127.0.0.1 || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      autoheal: true

  ## for autohealing ##
  autoheal:
    restart: unless-stopped
    image: willfarrell/autoheal:latest
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

## For IPVlan networking mode ##
networks:
  adguard:
    driver: ipvlan
    driver_opts:
      parent: eth0 # host interface
      ipvlan_mode: l2 # layer2 mode
    ipam:
      config:
        - subnet: 192.168.0.0/24 # your local subnet present on the interface
          gateway: 192.168.0.1 # the gateway of the network
          ip_range: 192.168.0.160/32 # IP of this container (can also be a range). Make sure it does not collide with any DHCP range!
